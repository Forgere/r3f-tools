name: Publish Package

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: npm-publish
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史记录（包含标签）
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        registry-url: 'https://registry.npmjs.org'
        
    - name: Create .npmrc for authentication
      run: |
        echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
        echo "always-auth=true" >> .npmrc
      env:
        NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build package
      run: npm run build
      
    - name: Verify package content
      run: |
        # 确保包含所有需要发布的文件
        ls -la dist/
        npx pkg-ok
        
    - name: Publish new package to npm
      run: npm publish --access public
      
    - name: Verify publication
      run: |
        PACKAGE_NAME=$(node -p "require('./package.json').name")
        echo "Successfully published $PACKAGE_NAME@$(npm view $PACKAGE_NAME version)"